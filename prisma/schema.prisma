generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model commit_tags {
  commit_id  String    @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  tag_name   String
  commits    commits   @relation(fields: [commit_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_commit_tags_commit")

  @@id([commit_id, tag_name])
}

model commits {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  prompt_id      String        @db.Uuid
  system_prompt  String
  user_query     String
  commit_message String?
  created_by     String        @db.Uuid
  created_at     DateTime?     @default(now()) @db.Timestamptz(6)
  commit_tags    commit_tags[]
  prompts        prompts       @relation(fields: [prompt_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_commits_prompt")
  prompt_runs    prompt_runs[]

  @@index([prompt_id])
  @@index([created_by])
  @@index([created_at(sort: Desc)])
}

model project_users {
  project_id String    @db.Uuid
  user_id    String    @db.Uuid
  role       String    @default("member")
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  projects   projects  @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_project_users_project")
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_project_users_user")

  @@id([project_id, user_id])
  @@index([user_id])
}

model projects {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  display_id    String?         @unique
  name          String
  description   String?
  created_by    String          @db.Uuid
  created_at    DateTime?       @default(now()) @db.Timestamptz(6)
  project_users project_users[]
  users         users           @relation(fields: [created_by], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_projects_created_by")
  prompts       prompts[]
  activities    activities[]
  chat_messages chat_messages[]

  @@index([created_by])
  @@index([created_at(sort: Desc)])
  @@index([name])
  @@index([description])
  @@index([display_id])
}

model prompt_runs {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  commit_id   String    @db.Uuid
  model_name  String
  response    String?
  latency_ms  Int?
  token_usage Json?
  status      String    @default("success")
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  commits     commits   @relation(fields: [commit_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_prompt_runs_commit")

  @@index([commit_id])
  @@index([created_at(sort: Desc)])
  @@index([status])
}

model prompts {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id String    @db.Uuid
  name       String
  created_by String    @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  commits    commits[]
  projects   projects  @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_prompts_project")

  @@index([project_id])
  @@index([created_by])
  @@index([name])
}

model users {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email             String              @unique
  name              String?
  image_url         String?
  created_at        DateTime?           @default(now()) @db.Timestamptz(6)
  password          String?
  project_users     project_users[]
  projects          projects[]
  activities        activities[]
  chat_messages     chat_messages[]
  message_reactions message_reactions[]
  token_usage       token_usage[]
  api_keys          api_keys[]
}

model api_keys {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  name       String
  key_hash   String    @unique
  status     String    @default("active")
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  user       users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_api_keys_user")

  @@index([user_id])
  @@index([key_hash])
  @@index([status])
}

model activities {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String?         @db.Uuid
  project_id  String?         @db.Uuid
  entity_type entity_type
  entity_id   String          @db.Uuid
  action      activity_action
  title       String
  metadata    Json?
  created_at  DateTime?       @default(now()) @db.Timestamptz(6)

  users       users?          @relation(fields: [user_id], references: [id], onDelete: SetNull, onUpdate: NoAction, map: "fk_activities_user")
  projects    projects?       @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_activities_project")

  @@index([project_id])
  @@index([user_id])
  @@index([entity_type])
  @@index([created_at(sort: Desc)])
}

enum entity_type {
  project
  prompt
  commit
  run
  tag
  member
}

enum activity_action {
  created
  updated
  deleted
  executed
  failed
}

model chat_messages {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id        String              @db.Uuid
  user_id           String?             @db.Uuid
  content           String
  parent_message_id String?             @db.Uuid
  created_at        DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at        DateTime?           @updatedAt

  project           projects            @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_chat_messages_project")
  user              users?              @relation(fields: [user_id], references: [id], onDelete: SetNull, onUpdate: NoAction, map: "fk_chat_messages_user")
  parent_message    chat_messages?      @relation("MessageReplies", fields: [parent_message_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_chat_messages_parent")
  replies           chat_messages[]     @relation("MessageReplies")
  reactions         message_reactions[]

  @@index([project_id])
  @@index([user_id])
  @@index([parent_message_id])
  @@index([created_at(sort: Desc)])
}

model message_reactions {
  id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  message_id String        @db.Uuid
  user_id    String        @db.Uuid
  emoji      String        // The emoji character (e.g., "üëç", "‚ù§Ô∏è", "üéâ")
  created_at DateTime?     @default(now()) @db.Timestamptz(6)

  message    chat_messages @relation(fields: [message_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_message_reactions_message")
  user       users         @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_message_reactions_user")

  @@unique([message_id, user_id, emoji]) // One user can only react once per emoji per message
  @@index([message_id])
  @@index([user_id])
}

model token_usage {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String?   @db.Uuid
  model_name    String
  input_tokens  Int
  output_tokens Int
  cost          Float?    @default(0)
  latency_ms    Int?
  system_prompt String?
  user_query    String?
  response      String?
  status        String    @default("success")
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  user          users?    @relation(fields: [user_id], references: [id], onDelete: SetNull, onUpdate: NoAction, map: "fk_token_usage_user")

  @@index([user_id])
  @@index([model_name])
  @@index([created_at(sort: Desc)])
  @@index([status])
  @@index([user_id, created_at(sort: Desc), model_name, status]) // Composite index for filtered queries
}
